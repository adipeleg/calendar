<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" type="text/css" href="task.css">
</head>

<body>
    <div class='header'>facebook</div>
    <div id='main-wrapper'>
        <div class='times-wrapper'>
            <div id='times'></div>
            <div id='times-two'></div>
        </div>
        <!-- <div id="container"></div> -->
    </div>

    <script>
        function buildTime(times, divId) {
            timeContainer = document.getElementById(divId);
            times.forEach(function (time) {
                var timeDiv = document.createElement("div");
                var time = document.createTextNode(time);
                timeDiv.appendChild(time);
                timeContainer.appendChild(timeDiv);
            })
        }
        function buildEventsView(events, index) {
            var mainContainer = document.getElementById('main-wrapper');
            var dailyContainer = document.createElement("div");
            dailyContainer.className = 'container';
            dailyContainer.id = 'day-' + index;
            mainContainer.appendChild(dailyContainer);
            events.forEach(function(event) {
                var text = document.createElement("div");
                var line1 = document.createTextNode("Sample Item");
                var text2 = document.createElement("div");
                var line2 = document.createTextNode("Sample Location");
                text.appendChild(line1)
                text.className = 'title';
                text2.appendChild(line2)
                text2.className = 'sub-title';
                eventWidth = containerWidth / event.numOfCollisions;
                eventHeight = event.end - event.start;
                var eventDiv = document.createElement("div");
                eventDiv.appendChild(text);
                eventDiv.appendChild(text2);
                eventDiv.className = 'event-div';
                var styleStr = `top:${event.top}px;left:${event.left}px;width:${eventWidth}px;height: ${eventHeight}px;`
                eventDiv.style.cssText = styleStr;
                dailyContainer.appendChild(eventDiv)
            })

        }
        function buildView(events, containerWidth) {
            buildEventsView(events, 1);
            var times = ['9:00', '10:00', '11:00', '12:00', '1:00', '2:00', '3:00', '4:00', '5:00', '6:00', '7:00',
                '8:00', '9:00'
            ];
            buildTime(times, "times");

            var times_two = ['AM', '9:30', 'AM', '10:30', 'AM', '11:30', 'PM', '12:30', 'PM', '1:30', 'PM', '2:30',
                'PM', '3:30', 'PM', '4:30', 'PM', '5:30', 'PM', '6:30',
                'PM', '7:30', 'PM', '8:30', 'PM'
            ];
            buildTime(times_two, "times-two");
        }

        function calcNumOfCollidingEvents(curr_ev, event, data) {
            event.numOfCollisions = event.numOfCollisions || 0;
            event.numOfCollisions = data[curr_ev.id].length > event.numOfCollisions ? data[curr_ev.id].length :
                event.numOfCollisions;
        }


        function addTopAndCalcNumOfCollEvents(events, data) {
            events.forEach(function(event, index) {
                event.top = event.start;
                data[event.id] = [];
                for (var j = 0; j <= index; j++) {
                    if (event.start < events[j].end) {
                        data[event.id].push(events[j]);
                    }
                    calcNumOfCollidingEvents(event, events[j], data);
                }
            })
        }

        function sortingArrayASC(events, key ) {
            events.sort(function (a, b) {
                return a[key] - b[key];
            });

        }
        function sortingArrayDESC(events, key ) {
            events.sort(function (a, b) {
                return b[key] - a[key];
            });

        }

        
        function findRealnumOfCollisions(events, data) {
            events.forEach(function(event) {
                var max = event.numOfCollisions;
                data[event.id].forEach(function (ev) {
                    max = max > ev.numOfCollisions ? max : ev.numOfCollisions;
                });
                data[event.id].forEach(function (ev) {
                    ev.numOfCollisions = max;
                });
            })
        }
        function calcEventLeftPos(containerWidth, curr_ev, data, count) {
            var partWidth = containerWidth / curr_ev.numOfCollisions;
            count = count || data[curr_ev.id].length - 1;
            var leftCandidate = (count % curr_ev.numOfCollisions) * partWidth + 10;
            return [leftCandidate, count];
        }
        
        function calcEventsLocation(events, containerWidth) {
            var data = {};
            sortingArrayASC(events, 'start')
            addTopAndCalcNumOfCollEvents(events, data);
            sortingArrayDESC(events, 'numOfCollisions')
            findRealnumOfCollisions(events, data);
            sortingArrayASC(events, 'start')
            findRealnumOfCollisions(events, data);
            events.forEach(function(event) {
                var count;
                var leftCandidate;
                [leftCandidate, count] = calcEventLeftPos(containerWidth, event, data);
                var blockedPos = [];
                data[event.id].forEach(function (ev) {
                    if (ev.id === event.id) {
                        return;
                    }
                    blockedPos.push(ev.left);
                });
                while (blockedPos.includes(leftCandidate)) {
                    count += 1;
                    [leftCandidate, count] = calcEventLeftPos(containerWidth, event, data, count);
                }
                event.left = leftCandidate;

            })
            return events;
        }

        function oneDayCalender(events, containerWidth) {
            events = calcEventsLocation(events, containerWidth)
            buildView(events, containerWidth)
        }
        
        
        events = [{
            id: 0,
            start: 30,
            end: 150
        }, {
            id: 1,
            start: 540,
            end: 600
        }, {
            id: 2,
            start: 560,
            end: 620
        }, {
            id: 3,
            start: 610,
            end: 670
        }]
        var containerWidth = 600;
        oneDayCalender(events, containerWidth)
    </script>

</body>

</html>